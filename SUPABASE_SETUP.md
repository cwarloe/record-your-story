# Supabase Setup Guide for Record Your Story v2.0

This guide walks you through setting up Supabase for cloud sync, authentication, and real-time features.

## Prerequisites

- Git repository initialized
- Node.js and npm installed
- TypeScript dependencies installed

## Step 1: Create Supabase Project

1. Go to [supabase.com](https://supabase.com)
2. Click "Start your project" and sign in (GitHub account recommended)
3. Click "New Project"
4. Fill in project details:
   - **Name:** `record-your-story` (or your preference)
   - **Database Password:** Generate a strong password (save it securely!)
   - **Region:** Choose closest to your users
   - **Pricing Plan:** Free tier is sufficient for development
5. Click "Create new project" (takes ~2 minutes to provision)

## Step 2: Run Database Schema

1. In your Supabase dashboard, click **SQL Editor** (left sidebar)
2. Click **New Query**
3. Copy the entire contents of `schema.sql` from this repository
4. Paste into the SQL editor
5. Click **Run** (bottom right)
6. Verify success - you should see "Success. No rows returned"

This creates:
- 6 database tables (users, timelines, events, event_photos, event_connections, event_mentions)
- Row Level Security (RLS) policies for privacy
- Indexes for performance
- Triggers for auto-updating timestamps and user profiles

## Step 3: Configure Environment Variables

1. In Supabase dashboard, click **Settings** → **API**
2. Copy your **Project URL** (looks like `https://xxxxx.supabase.co`)
3. Copy your **anon public** key (long string starting with `eyJ...`)
4. In your project root, create `.env` file:

```bash
cp .env.example .env
```

5. Edit `.env` and replace placeholders:

```env
VITE_SUPABASE_URL=https://your-actual-project-id.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

⚠️ **Important:** Add `.env` to `.gitignore` to keep credentials secret!

```bash
echo ".env" >> .gitignore
```

## Step 4: Enable Google OAuth (Optional)

To allow "Sign in with Google":

1. In Supabase dashboard, go to **Authentication** → **Providers**
2. Find **Google** and toggle **Enable Sign in with Google**
3. You'll see configuration fields:
   - **Client IDs:** Enter `record-your-story` (or leave default)
   - **Client Secret (for OAuth):** This is auto-generated by Supabase
   - **Callback URL:** Copy this URL - you'll need it if setting up Google Cloud Console
4. Click **Save**

**Note:** The basic Google OAuth will work with just toggling it on. Advanced configuration with Google Cloud Console is only needed for production apps with custom branding.

## Step 5: Verify Setup

Run the development server:

```bash
npm run dev
```

Visit `http://localhost:3000` and test:
- Sign up with email/password
- Check Supabase dashboard → **Authentication** → **Users** (you should see your user)
- Check **Table Editor** → **users** (profile should auto-create)

## Database Tables Overview

### `users`
User profiles (auto-created on signup via trigger)

### `timelines`
User's multiple timelines (personal, family, work, shared)

### `events`
Life events with rich content, tags, mentions, visibility controls

### `event_photos`
Photos attached to events (base64 encoded, unlimited storage)

### `event_connections`
Links between related events (manual or AI-suggested)

### `event_mentions`
Tagging system - when you tag someone in your event, they see it on their timeline

## Security

All tables have **Row Level Security (RLS)** enabled:

- Users can only view/edit their own data
- Mentioned users can see events they're tagged in
- Visibility controls restrict access based on event settings
- SQL injection protection via parameterized queries
- Auth token validation on every request

## Real-time Features

Supabase automatically enables real-time subscriptions. The app uses:

- `subscribeToEvents(timeline_id)` - Live updates when events change
- Future: Notification system for mentions and connections

## Troubleshooting

### "Invalid API key" error
- Check `.env` file exists and has correct values
- Restart dev server after changing `.env`
- Verify VITE_ prefix (required for Vite to expose variables)

### "relation does not exist" error
- Run `schema.sql` in SQL Editor
- Check for error messages in SQL execution
- Verify all tables created in Table Editor

### Can't sign up
- Check Authentication → Settings → Email Auth is enabled
- Check email confirmations (Settings → Auth → Email Templates)
- For development, disable "Confirm email" in Auth settings

### RLS policy errors
- Check user is authenticated (`getCurrentUser()` returns user)
- Verify policies in Table Editor → [table] → RLS Policies
- Check Supabase logs for policy violations

## Next Steps

Once setup is complete:

1. Run `npm run dev` to start development server
2. Test authentication flow
3. Start building UI components
4. Migrate v1.0 features to cloud-backed version

## Resources

- [Supabase Documentation](https://supabase.com/docs)
- [Supabase JavaScript Client](https://supabase.com/docs/reference/javascript/introduction)
- [Row Level Security Guide](https://supabase.com/docs/guides/auth/row-level-security)
- [Real-time Subscriptions](https://supabase.com/docs/guides/realtime)
